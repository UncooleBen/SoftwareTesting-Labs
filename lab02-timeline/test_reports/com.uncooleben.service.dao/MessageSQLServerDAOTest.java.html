<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessageSQLServerDAOTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lab02_timeline$com_uncooleben_in_lab02_timeline.exec</a> &gt; <a href="index.source.html" class="el_package">com.uncooleben.service.dao</a> &gt; <span class="el_source">MessageSQLServerDAOTest.java</span></div><h1>MessageSQLServerDAOTest.java</h1><pre class="source lang-java linenums">package com.uncooleben.service.dao;

import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertNull;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.anyInt;
import static org.mockito.Mockito.anyString;
import static org.mockito.Mockito.doThrow;
import static org.mockito.Mockito.inOrder;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.spy;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.when;

import com.uncooleben.model.Message;
import java.io.ByteArrayOutputStream;
import java.io.PrintStream;
import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.List;
import java.util.Locale;
import java.util.UUID;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;
import org.mockito.InOrder;

<span class="fc" id="L39">public class MessageSQLServerDAOTest {</span>
  private MessageSQLServerDAO messageDAO;
<span class="fc" id="L41">  private Connection connection = mock(Connection.class);</span>
<span class="fc" id="L42">  private PreparedStatement pstmt = mock(PreparedStatement.class);</span>
<span class="fc" id="L43">  private Message message = mock(Message.class);</span>
<span class="fc" id="L44">  private ResultSet rs = mock(ResultSet.class);</span>
  private Locale defaultLocale;
  ByteArrayOutputStream errContent;
  PrintStream originalErr;
<span class="fc" id="L48">  private DateFormat dateFormatter = new SimpleDateFormat(&quot;yyyy-MM-dd hh:mm:ss&quot;);</span>
<span class="fc" id="L49">  private final String TEST_USERNAME = &quot;testUsername&quot;;</span>
<span class="fc" id="L50">  private final String TEST_CONTENT = &quot;testContent&quot;;</span>
<span class="fc" id="L51">  private final String TEST_UUID = &quot;0-0-0-0-0&quot;;</span>
<span class="fc" id="L52">  private final String TEST_TIME = &quot;2019-10-30 12:00:00&quot;;</span>
<span class="fc" id="L53">  private final String TEST_PATH = &quot;testPath&quot;;</span>
<span class="fc" id="L54">  private final long TEST_MILLISEC = 1572364800000L; // Equal to TEST_TIME</span>
<span class="fc" id="L55">  private final String TEST_USERNAME2 = &quot;testUsername2&quot;;</span>
<span class="fc" id="L56">  private final String TEST_CONTENT2 = &quot;testContent2&quot;;</span>
<span class="fc" id="L57">  private final String TEST_UUID2 = &quot;0-0-0-0-1&quot;;</span>
<span class="fc" id="L58">  private final String TEST_TIME2 = &quot;2019-10-30 08:00:00&quot;;</span>

<span class="fc" id="L60">  class MessageSQLServerDAOFake extends MessageSQLServerDAO {</span>
    @Override
<span class="nc" id="L62">    protected void loadDriver() {}</span>

    @Override
    protected Connection getConnection() {
<span class="fc" id="L66">      return connection;</span>
    }
  }

  @BeforeEach
  void init() {
<span class="fc" id="L72">    messageDAO = new MessageSQLServerDAOFake();</span>
<span class="fc" id="L73">    defaultLocale = Locale.getDefault();</span>
<span class="fc" id="L74">    Locale.setDefault(Locale.CHINA);</span>
    // Change error output stream to capture error output
<span class="fc" id="L76">    errContent = new ByteArrayOutputStream();</span>
<span class="fc" id="L77">    originalErr = System.err;</span>
<span class="fc" id="L78">    System.setErr(new PrintStream(errContent));</span>
<span class="fc" id="L79">  }</span>

  @AfterEach
  void restore() {
<span class="fc" id="L83">    Locale.setDefault(defaultLocale);</span>
    // Change error output stream back to default
<span class="fc" id="L85">    System.setErr(originalErr);</span>
<span class="fc" id="L86">  }</span>

  @Test
  void testStoreNullMessageWithoutImageThrowsException() {
<span class="pc" id="L90">    assertThrows(NullPointerException.class, () -&gt; messageDAO.storeMessage(null, true));</span>
<span class="fc" id="L91">  }</span>

  @Test
  void testStoreOneMessageWithoutImage() throws Exception {
<span class="fc" id="L95">    String INSERT =</span>
        &quot;INSERT INTO message(uuid, username, content, time, withImage, path) VALUES(?,?,?,?,?,?)&quot;;
<span class="fc" id="L97">    Date date = mock(Date.class);</span>
    // Stub
<span class="fc" id="L99">    when(connection.prepareStatement(INSERT, Statement.RETURN_GENERATED_KEYS)).thenReturn(pstmt);</span>
<span class="fc" id="L100">    when(message.get_uuid()).thenReturn(UUID.fromString(TEST_UUID));</span>
<span class="fc" id="L101">    when(message.get_username()).thenReturn(TEST_USERNAME);</span>
<span class="fc" id="L102">    when(message.get_content()).thenReturn(TEST_CONTENT);</span>
<span class="fc" id="L103">    when(message.get_time()).thenReturn(date);</span>
    // Test return value
<span class="fc" id="L105">    boolean succeed = messageDAO.storeMessage(message, false);</span>
<span class="fc" id="L106">    assertTrue(succeed);</span>
    // Test function calls' order and capture arguments
<span class="fc" id="L108">    InOrder order = inOrder(pstmt, connection);</span>
<span class="fc" id="L109">    ArgumentCaptor&lt;String&gt; argsCap = ArgumentCaptor.forClass(String.class);</span>
<span class="fc" id="L110">    order.verify(connection).prepareStatement(INSERT, Statement.RETURN_GENERATED_KEYS);</span>
<span class="fc" id="L111">    order.verify(pstmt, times(4)).setString(anyInt(), argsCap.capture());</span>
<span class="fc" id="L112">    order.verify(pstmt).setBoolean(5, false);</span>
<span class="fc" id="L113">    order.verify(pstmt).setString(6, null);</span>
<span class="fc" id="L114">    order.verify(pstmt).execute();</span>
<span class="fc" id="L115">    order.verify(pstmt).close();</span>
<span class="fc" id="L116">    order.verify(connection).close();</span>
<span class="fc" id="L117">    order.verifyNoMoreInteractions();</span>
    // Test arguments' order and value
<span class="fc" id="L119">    assertEquals(TEST_USERNAME, argsCap.getAllValues().get(1));</span>
<span class="fc" id="L120">    assertEquals(TEST_CONTENT, argsCap.getAllValues().get(2));</span>
<span class="fc" id="L121">  }</span>

  @Test
  void testStoreMessageWithoutImageThrowsSQLException() throws Exception {
    // Stub
<span class="fc" id="L126">    when(connection.prepareStatement(anyString(), anyInt())).thenThrow(SQLException.class);</span>
    // Test return value
<span class="fc" id="L128">    boolean succeed = true;</span>
<span class="fc" id="L129">    succeed = messageDAO.storeMessage(message, false);</span>
<span class="fc" id="L130">    assertFalse(succeed);</span>
    // Test error output
<span class="fc" id="L132">    assertTrue(errContent.toString().contains(&quot;java.sql.SQLException&quot;));</span>
<span class="fc" id="L133">  }</span>

  @Test
  void testStoreNullMessageWithImageThrowsException() {
<span class="pc" id="L137">    assertThrows(NullPointerException.class, () -&gt; messageDAO.storeMessage(null, true));</span>
<span class="fc" id="L138">  }</span>

  @Test
  void testStoreOneMessageWithImage() throws Exception {
<span class="fc" id="L142">    String INSERT =</span>
        &quot;INSERT INTO message(uuid, username, content, time, withImage, path) VALUES(?,?,?,?,?,?)&quot;;
<span class="fc" id="L144">    Date date = mock(Date.class);</span>
<span class="fc" id="L145">    messageDAO = spy(messageDAO);</span>
    // Stub
<span class="fc" id="L147">    when(connection.prepareStatement(INSERT, Statement.RETURN_GENERATED_KEYS)).thenReturn(pstmt);</span>
<span class="fc" id="L148">    when(message.get_uuid()).thenReturn(UUID.fromString(TEST_UUID));</span>
<span class="fc" id="L149">    when(message.get_username()).thenReturn(TEST_USERNAME);</span>
<span class="fc" id="L150">    when(message.get_content()).thenReturn(TEST_CONTENT);</span>
<span class="fc" id="L151">    when(message.get_time()).thenReturn(date);</span>
    // Test return value
<span class="fc" id="L153">    boolean succeed = messageDAO.storeMessage(message, true);</span>
<span class="fc" id="L154">    assertTrue(succeed);</span>
    // Test function calls' order and capture arguments
<span class="fc" id="L156">    InOrder order = inOrder(pstmt, connection, messageDAO);</span>
<span class="fc" id="L157">    ArgumentCaptor&lt;String&gt; argsCap = ArgumentCaptor.forClass(String.class);</span>
<span class="fc" id="L158">    order.verify(connection).prepareStatement(INSERT, Statement.RETURN_GENERATED_KEYS);</span>
<span class="fc" id="L159">    order.verify(pstmt, times(4)).setString(anyInt(), argsCap.capture());</span>
<span class="fc" id="L160">    order.verify(pstmt).setBoolean(5, true);</span>
<span class="fc" id="L161">    order.verify(pstmt).setString(eq(6), anyString());</span>
<span class="fc" id="L162">    order.verify(pstmt).execute();</span>
<span class="fc" id="L163">    order.verify(pstmt).close();</span>
<span class="fc" id="L164">    order.verify(connection).close();</span>
<span class="fc" id="L165">    order.verifyNoMoreInteractions();</span>
    // Test arguments' order and value
<span class="fc" id="L167">    assertEquals(TEST_USERNAME, argsCap.getAllValues().get(1));</span>
<span class="fc" id="L168">    assertEquals(TEST_CONTENT, argsCap.getAllValues().get(2));</span>
<span class="fc" id="L169">  }</span>

  @Test
  void testStoreMessageWithImageThrowsSQLException() throws Exception {
<span class="fc" id="L173">    messageDAO = spy(messageDAO);</span>
    // Stub
<span class="fc" id="L175">    when(connection.prepareStatement(anyString(), anyInt())).thenThrow(SQLException.class);</span>
<span class="fc" id="L176">    when(message.get_uuid()).thenReturn(UUID.fromString(TEST_UUID));</span>
    // Test return value
<span class="fc" id="L178">    boolean succeed = messageDAO.storeMessage(message, true);</span>
<span class="fc" id="L179">    assertFalse(succeed);</span>
    // Test error output
<span class="fc" id="L181">    assertTrue(errContent.toString().contains(&quot;java.sql.SQLException&quot;));</span>
<span class="fc" id="L182">  }</span>

  @Test
  void testQueryMessageByUUIDReturnNoImage() throws Exception {
<span class="fc" id="L186">    String SELECT = &quot;SELECT * FROM message WHERE uuid=(?)&quot;;</span>
    // Stub
<span class="fc" id="L188">    when(connection.prepareStatement(SELECT, Statement.RETURN_GENERATED_KEYS)).thenReturn(pstmt);</span>
<span class="fc" id="L189">    when(pstmt.executeQuery()).thenReturn(rs);</span>
<span class="fc" id="L190">    when(rs.getString(&quot;uuid&quot;)).thenReturn(TEST_UUID);</span>
<span class="fc" id="L191">    when(rs.getString(&quot;username&quot;)).thenReturn(TEST_USERNAME);</span>
<span class="fc" id="L192">    when(rs.getString(&quot;content&quot;)).thenReturn(TEST_CONTENT);</span>
<span class="fc" id="L193">    when(rs.getString(&quot;time&quot;)).thenReturn(TEST_TIME);</span>
<span class="fc" id="L194">    when(rs.getBoolean(&quot;withImage&quot;)).thenReturn(false);</span>
<span class="fc" id="L195">    when(rs.next()).thenReturn(true, false); // Only one item in ResultSet</span>
    // Test return value
<span class="fc" id="L197">    List&lt;Message&gt; resultList = messageDAO.queryMessageByUUID(UUID.fromString(TEST_UUID));</span>
<span class="fc" id="L198">    assertEquals(1, resultList.size());</span>
<span class="fc" id="L199">    assertEquals(UUID.fromString(TEST_UUID), resultList.get(0).get_uuid());</span>
<span class="fc" id="L200">    assertEquals(TEST_USERNAME, resultList.get(0).get_username());</span>
<span class="fc" id="L201">    assertEquals(TEST_CONTENT, resultList.get(0).get_content());</span>
<span class="fc" id="L202">    assertEquals(TEST_TIME, dateFormatter.format(resultList.get(0).get_time()));</span>
<span class="fc" id="L203">    assertNull(resultList.get(0).get_path());</span>
    // Test function calls' order
<span class="fc" id="L205">    InOrder order = inOrder(connection, pstmt, rs);</span>
<span class="fc" id="L206">    order.verify(connection).prepareStatement(SELECT, Statement.RETURN_GENERATED_KEYS);</span>
<span class="fc" id="L207">    order.verify(pstmt).executeQuery();</span>
<span class="fc" id="L208">    order.verify(rs).next();</span>
<span class="fc" id="L209">    order.verify(rs, times(4)).getString(anyString());</span>
<span class="fc" id="L210">    order.verify(rs).getBoolean(anyString());</span>
<span class="fc" id="L211">    order.verify(pstmt).close();</span>
<span class="fc" id="L212">    order.verify(connection).close();</span>
<span class="fc" id="L213">    order.verifyNoMoreInteractions();</span>
<span class="fc" id="L214">  }</span>

  @Test
  void testQueryMessageByUUIDReturnImage() throws Exception {
<span class="fc" id="L218">    String SELECT = &quot;SELECT * FROM message WHERE uuid=(?)&quot;;</span>
    // Stub
<span class="fc" id="L220">    when(connection.prepareStatement(SELECT, Statement.RETURN_GENERATED_KEYS)).thenReturn(pstmt);</span>
<span class="fc" id="L221">    when(pstmt.executeQuery()).thenReturn(rs);</span>
<span class="fc" id="L222">    when(rs.getString(&quot;uuid&quot;)).thenReturn(TEST_UUID);</span>
<span class="fc" id="L223">    when(rs.getString(&quot;username&quot;)).thenReturn(TEST_USERNAME);</span>
<span class="fc" id="L224">    when(rs.getString(&quot;content&quot;)).thenReturn(TEST_CONTENT);</span>
<span class="fc" id="L225">    when(rs.getString(&quot;time&quot;)).thenReturn(TEST_TIME);</span>
<span class="fc" id="L226">    when(rs.getBoolean(&quot;withImage&quot;)).thenReturn(true);</span>
<span class="fc" id="L227">    when(rs.getString(&quot;path&quot;)).thenReturn(TEST_PATH);</span>
<span class="fc" id="L228">    when(rs.next()).thenReturn(true, false); // Only one item in ResultSet</span>
    // Test return value
<span class="fc" id="L230">    List&lt;Message&gt; resultList = messageDAO.queryMessageByUUID(UUID.fromString(TEST_UUID));</span>
<span class="fc" id="L231">    assertEquals(1, resultList.size());</span>
<span class="fc" id="L232">    assertEquals(UUID.fromString(TEST_UUID), resultList.get(0).get_uuid());</span>
<span class="fc" id="L233">    assertEquals(TEST_USERNAME, resultList.get(0).get_username());</span>
<span class="fc" id="L234">    assertEquals(TEST_CONTENT, resultList.get(0).get_content());</span>
<span class="fc" id="L235">    assertEquals(TEST_TIME, dateFormatter.format(resultList.get(0).get_time()));</span>
<span class="fc" id="L236">    assertEquals(TEST_PATH, resultList.get(0).get_path());</span>
    // Test function calls' order
<span class="fc" id="L238">    InOrder order = inOrder(connection, pstmt, rs);</span>
<span class="fc" id="L239">    order.verify(connection).prepareStatement(SELECT, Statement.RETURN_GENERATED_KEYS);</span>
<span class="fc" id="L240">    order.verify(pstmt).executeQuery();</span>
<span class="fc" id="L241">    order.verify(rs).next();</span>
<span class="fc" id="L242">    order.verify(rs, times(4)).getString(anyString());</span>
<span class="fc" id="L243">    order.verify(rs).getBoolean(anyString());</span>
<span class="fc" id="L244">    order.verify(rs).getString(anyString());</span>
<span class="fc" id="L245">    order.verify(pstmt).close();</span>
<span class="fc" id="L246">    order.verify(connection).close();</span>
<span class="fc" id="L247">    order.verifyNoMoreInteractions();</span>
<span class="fc" id="L248">  }</span>

  @Test
  void testQueryMessageByNullUUIDThrowsException() {
<span class="pc" id="L252">    assertThrows(NullPointerException.class, () -&gt; messageDAO.queryMessageByUUID(null));</span>
<span class="fc" id="L253">  }</span>

  @Test
  void testQueryMessageByUUIDThrowsSQLExceptionWhenPreparingStatement() throws Exception {
    // Stub
<span class="fc" id="L258">    when(connection.prepareStatement(anyString(), anyInt())).thenThrow(SQLException.class);</span>
    // Test return value
<span class="fc" id="L260">    List&lt;Message&gt; resultList = messageDAO.queryMessageByUUID(UUID.fromString(TEST_UUID));</span>
<span class="fc" id="L261">    assertTrue(resultList.isEmpty()); // resultList should be empty</span>
    // Test error output
<span class="fc" id="L263">    assertTrue(errContent.toString().contains(&quot;java.sql.SQLException&quot;));</span>
<span class="fc" id="L264">  }</span>

  @Test
  void testQueryMessageByUUIDThrowsSQLExceptionWhenExecutingQuery() throws Exception {
    // Stub
<span class="fc" id="L269">    when(connection.prepareStatement(anyString(), anyInt())).thenReturn(pstmt);</span>
<span class="fc" id="L270">    when(pstmt.executeQuery()).thenThrow(SQLException.class);</span>
    // Test return value
<span class="fc" id="L272">    List&lt;Message&gt; resultList = messageDAO.queryMessageByUUID(UUID.fromString(TEST_UUID));</span>
<span class="fc" id="L273">    assertTrue(resultList.isEmpty()); // resultList should be empty</span>
    // Test error output
<span class="fc" id="L275">    assertTrue(errContent.toString().contains(&quot;java.sql.SQLException&quot;));</span>
<span class="fc" id="L276">  }</span>

  @Test
  void testQueryMessageWithSize1AndMillisec1572364800000WithImage() throws Exception {
<span class="fc" id="L280">    String SELECT = &quot;SELECT TOP 1 * FROM message WHERE time &lt;= ? ORDER BY time DESC&quot;;</span>
    // Stub
<span class="fc" id="L282">    when(connection.prepareStatement(SELECT, Statement.RETURN_GENERATED_KEYS)).thenReturn(pstmt);</span>
<span class="fc" id="L283">    when(pstmt.executeQuery()).thenReturn(rs);</span>
<span class="fc" id="L284">    when(rs.next()).thenReturn(true, false); // rs has only 1 item</span>
<span class="fc" id="L285">    when(rs.getString(&quot;uuid&quot;)).thenReturn(TEST_UUID);</span>
<span class="fc" id="L286">    when(rs.getString(&quot;username&quot;)).thenReturn(TEST_USERNAME);</span>
<span class="fc" id="L287">    when(rs.getString(&quot;content&quot;)).thenReturn(TEST_CONTENT);</span>
<span class="fc" id="L288">    when(rs.getString(&quot;time&quot;)).thenReturn(TEST_TIME);</span>
<span class="fc" id="L289">    when(rs.getBoolean(&quot;withImage&quot;)).thenReturn(true);</span>
<span class="fc" id="L290">    when(rs.getString(&quot;path&quot;)).thenReturn(TEST_PATH);</span>
    // Test return value
<span class="fc" id="L292">    List&lt;Message&gt; resultList = messageDAO.queryMessage(1, TEST_MILLISEC);</span>
<span class="fc" id="L293">    assertEquals(1, resultList.size());</span>
<span class="fc" id="L294">    assertEquals(UUID.fromString(TEST_UUID), resultList.get(0).get_uuid());</span>
<span class="fc" id="L295">    assertEquals(TEST_USERNAME, resultList.get(0).get_username());</span>
<span class="fc" id="L296">    assertEquals(TEST_CONTENT, resultList.get(0).get_content());</span>
<span class="fc" id="L297">    assertEquals(TEST_TIME, dateFormatter.format(resultList.get(0).get_time()));</span>
    // Test function calls' order
<span class="fc" id="L299">    InOrder order = inOrder(connection, pstmt, rs);</span>
<span class="fc" id="L300">    order.verify(connection).prepareStatement(SELECT, Statement.RETURN_GENERATED_KEYS);</span>
<span class="fc" id="L301">    order.verify(pstmt).executeQuery();</span>
<span class="fc" id="L302">    order.verify(rs).next();</span>
<span class="fc" id="L303">    order.verify(rs, times(4)).getString(anyString());</span>
<span class="fc" id="L304">    order.verify(rs).getBoolean(anyString());</span>
<span class="fc" id="L305">    order.verify(rs).getString(anyString());</span>
<span class="fc" id="L306">    order.verify(rs).next();</span>
<span class="fc" id="L307">    order.verify(pstmt).close();</span>
<span class="fc" id="L308">    order.verify(connection).close();</span>
<span class="fc" id="L309">    order.verifyNoMoreInteractions();</span>
<span class="fc" id="L310">  }</span>

  @Test
  void testQueryMessageWithSize2AndMillisec1572364800000WithoutImage() throws Exception {
<span class="fc" id="L314">    String SELECT = &quot;SELECT TOP 2 * FROM message WHERE time &lt;= ? ORDER BY time DESC&quot;;</span>
    // Stub
<span class="fc" id="L316">    when(connection.prepareStatement(SELECT, Statement.RETURN_GENERATED_KEYS)).thenReturn(pstmt);</span>
<span class="fc" id="L317">    when(pstmt.executeQuery()).thenReturn(rs);</span>
<span class="fc" id="L318">    when(rs.next()).thenReturn(true, true, false); // rs has 2 items</span>
<span class="fc" id="L319">    when(rs.getString(&quot;uuid&quot;)).thenReturn(TEST_UUID, TEST_UUID2);</span>
<span class="fc" id="L320">    when(rs.getString(&quot;username&quot;)).thenReturn(TEST_USERNAME, TEST_USERNAME2);</span>
<span class="fc" id="L321">    when(rs.getString(&quot;content&quot;)).thenReturn(TEST_CONTENT, TEST_CONTENT2);</span>
<span class="fc" id="L322">    when(rs.getString(&quot;time&quot;)).thenReturn(TEST_TIME, TEST_TIME2);</span>
<span class="fc" id="L323">    when(rs.getBoolean(&quot;withImage&quot;)).thenReturn(false, false);</span>
    // Test return value
<span class="fc" id="L325">    List&lt;Message&gt; resultList = messageDAO.queryMessage(2, TEST_MILLISEC);</span>
<span class="fc" id="L326">    assertEquals(2, resultList.size());</span>
<span class="fc" id="L327">    assertEquals(UUID.fromString(TEST_UUID), resultList.get(0).get_uuid());</span>
<span class="fc" id="L328">    assertEquals(TEST_USERNAME, resultList.get(0).get_username());</span>
<span class="fc" id="L329">    assertEquals(TEST_CONTENT, resultList.get(0).get_content());</span>
<span class="fc" id="L330">    assertEquals(TEST_TIME, dateFormatter.format(resultList.get(0).get_time()));</span>
<span class="fc" id="L331">    assertEquals(UUID.fromString(TEST_UUID2), resultList.get(1).get_uuid());</span>
<span class="fc" id="L332">    assertEquals(TEST_USERNAME2, resultList.get(1).get_username());</span>
<span class="fc" id="L333">    assertEquals(TEST_CONTENT2, resultList.get(1).get_content());</span>
<span class="fc" id="L334">    assertEquals(TEST_TIME2, dateFormatter.format(resultList.get(1).get_time()));</span>
    // Test function calls' order
<span class="fc" id="L336">    InOrder order = inOrder(connection, pstmt, rs);</span>
<span class="fc" id="L337">    order.verify(connection).prepareStatement(SELECT, Statement.RETURN_GENERATED_KEYS);</span>
<span class="fc" id="L338">    order.verify(pstmt).executeQuery();</span>
<span class="fc" id="L339">    order.verify(rs).next();</span>
<span class="fc" id="L340">    order.verify(rs, times(4)).getString(anyString());</span>
<span class="fc" id="L341">    order.verify(rs).getBoolean(anyString());</span>
<span class="fc" id="L342">    order.verify(rs).next();</span>
<span class="fc" id="L343">    order.verify(rs, times(4)).getString(anyString());</span>
<span class="fc" id="L344">    order.verify(rs).getBoolean(anyString());</span>
<span class="fc" id="L345">    order.verify(rs).next();</span>
<span class="fc" id="L346">    order.verify(pstmt).close();</span>
<span class="fc" id="L347">    order.verify(connection).close();</span>
<span class="fc" id="L348">    order.verifyNoMoreInteractions();</span>
<span class="fc" id="L349">  }</span>

  @Test
  void testQueryMessageThrowsSQLException() throws Exception {
    // Stub
<span class="fc" id="L354">    when(connection.prepareStatement(anyString(), anyInt())).thenThrow(SQLException.class);</span>
    // Test return value
<span class="fc" id="L356">    List&lt;Message&gt; result = messageDAO.queryMessage(0, 0);</span>
<span class="fc" id="L357">    assertEquals(0, result.size());</span>
    // Test error output
<span class="fc" id="L359">    assertTrue(errContent.toString().contains(&quot;java.sql.SQLException&quot;));</span>
<span class="fc" id="L360">  }</span>

  @Test
  void testQueryUpdates() throws Exception {
<span class="fc" id="L364">    String SELECT = &quot;SELECT COUNT(*) FROM message WHERE time &gt; ?&quot;;</span>
    // Stub
<span class="fc" id="L366">    when(connection.prepareStatement(SELECT, Statement.RETURN_GENERATED_KEYS)).thenReturn(pstmt);</span>
<span class="fc" id="L367">    when(pstmt.executeQuery()).thenReturn(rs);</span>
<span class="fc" id="L368">    when(rs.next()).thenReturn(true);</span>
<span class="fc" id="L369">    when(rs.getInt(1)).thenReturn(3);</span>
    // Test return value
<span class="fc" id="L371">    int result = messageDAO.queryUpdates(TEST_MILLISEC);</span>
<span class="fc" id="L372">    assertEquals(3, result);</span>
    // Test function calls' order
<span class="fc" id="L374">    InOrder order = inOrder(connection, pstmt, rs);</span>
<span class="fc" id="L375">    order.verify(connection).prepareStatement(SELECT, Statement.RETURN_GENERATED_KEYS);</span>
<span class="fc" id="L376">    order.verify(pstmt).executeQuery();</span>
<span class="fc" id="L377">    order.verify(rs).next();</span>
<span class="fc" id="L378">    order.verify(rs).getInt(1);</span>
<span class="fc" id="L379">    order.verify(pstmt).close();</span>
<span class="fc" id="L380">    order.verify(connection).close();</span>
<span class="fc" id="L381">    order.verifyNoMoreInteractions();</span>
<span class="fc" id="L382">  }</span>

  @Test
  void testQueryUpdatesThrowsSQLException() throws Exception {
    // Stub
<span class="fc" id="L387">    when(connection.prepareStatement(anyString(), anyInt())).thenThrow(SQLException.class);</span>
    // Test return value
<span class="fc" id="L389">    int result = messageDAO.queryUpdates(TEST_MILLISEC);</span>
<span class="fc" id="L390">    assertEquals(0, result);</span>
    // Test error output
<span class="fc" id="L392">    assertTrue(errContent.toString().contains(&quot;java.sql.SQLException&quot;));</span>
<span class="fc" id="L393">  }</span>

  @Test
  void testQueryUpdatesWhenResultSetHasNothing() throws Exception {
<span class="fc" id="L397">    String SELECT = &quot;SELECT COUNT(*) FROM message WHERE time &gt; ?&quot;;</span>
    // Stub
<span class="fc" id="L399">    when(connection.prepareStatement(SELECT, Statement.RETURN_GENERATED_KEYS)).thenReturn(pstmt);</span>
<span class="fc" id="L400">    when(pstmt.executeQuery()).thenReturn(rs);</span>
<span class="fc" id="L401">    when(rs.next()).thenReturn(false);</span>
    // Test return value
<span class="fc" id="L403">    int result = messageDAO.queryUpdates(TEST_MILLISEC);</span>
<span class="fc" id="L404">    assertEquals(0, result);</span>
    // Test function calls' order
<span class="fc" id="L406">    InOrder order = inOrder(connection, pstmt, rs);</span>
<span class="fc" id="L407">    order.verify(connection).prepareStatement(SELECT, Statement.RETURN_GENERATED_KEYS);</span>
<span class="fc" id="L408">    order.verify(pstmt).executeQuery();</span>
<span class="fc" id="L409">    order.verify(rs).next();</span>
<span class="fc" id="L410">    order.verify(pstmt).close();</span>
<span class="fc" id="L411">    order.verify(connection).close();</span>
<span class="fc" id="L412">    order.verifyNoMoreInteractions();</span>
<span class="fc" id="L413">  }</span>

  @Test
  void testClearTable() throws Exception {
<span class="fc" id="L417">    String DELETE = &quot;DELETE FROM message&quot;;</span>
    // Stub
<span class="fc" id="L419">    when(connection.prepareStatement(DELETE, Statement.RETURN_GENERATED_KEYS)).thenReturn(pstmt);</span>
    // Test return value
<span class="fc" id="L421">    boolean result = messageDAO.clearTable();</span>
<span class="fc" id="L422">    assertTrue(result);</span>
    // Test function calls' order
<span class="fc" id="L424">    InOrder order = inOrder(connection, pstmt);</span>
<span class="fc" id="L425">    order.verify(connection).prepareStatement(DELETE, Statement.RETURN_GENERATED_KEYS);</span>
<span class="fc" id="L426">    order.verify(pstmt).execute();</span>
<span class="fc" id="L427">    order.verify(pstmt).close();</span>
<span class="fc" id="L428">    order.verify(connection).close();</span>
<span class="fc" id="L429">    order.verifyNoMoreInteractions();</span>
<span class="fc" id="L430">  }</span>

  @Test
  void testClearTableThrowsSQLException() throws Exception {
    // Stub
<span class="fc" id="L435">    when(connection.prepareStatement(anyString(), anyInt())).thenThrow(SQLException.class);</span>
<span class="fc" id="L436">    messageDAO.clearTable();</span>
    // Test error output
<span class="fc" id="L438">    assertTrue(errContent.toString().contains(&quot;java.sql.SQLException&quot;));</span>
<span class="fc" id="L439">  }</span>

  @Test
  void testCloseStatementThrowsSQLException() throws Exception {
    // Stub
<span class="fc" id="L444">    doThrow(SQLException.class).when(pstmt).close();</span>
<span class="fc" id="L445">    messageDAO.closeStatementAndConnection(pstmt, connection);</span>
    // Test error output
<span class="fc" id="L447">    assertTrue(errContent.toString().contains(&quot;java.sql.SQLException&quot;));</span>
<span class="fc" id="L448">  }</span>

  @Test
  void testCloseConnectionThrowsSQLException() throws Exception {
    // Stub
<span class="fc" id="L453">    doThrow(SQLException.class).when(connection).close();</span>
<span class="fc" id="L454">    messageDAO.closeStatementAndConnection(pstmt, connection);</span>
    // Test error output
<span class="fc" id="L456">    assertTrue(errContent.toString().contains(&quot;java.sql.SQLException&quot;));</span>
<span class="fc" id="L457">  }</span>

  @Test
  void testCloseNullStatement() {
<span class="fc" id="L461">    assertDoesNotThrow(() -&gt; messageDAO.closeStatementAndConnection(null, connection));</span>
<span class="fc" id="L462">  }</span>

  @Test
  void testCloseNullConnection() {
<span class="fc" id="L466">    assertDoesNotThrow(() -&gt; messageDAO.closeStatementAndConnection(pstmt, null));</span>
<span class="fc" id="L467">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>